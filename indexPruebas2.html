<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/Png/icon.png">
    <!-- Scripts -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script
        src="https://unpkg.com/aframe-environment-component@1.5.x/dist/aframe-environment-component.min.js"></script>
    <script src="aframe-physics-system.min.js"></script>
    <script>
        // ==========================
        //   COMPONENTE: Encender ventanas
        // ==========================
        AFRAME.registerComponent('encender-ventanas', {
            init: function () {
                this.encendidas = false;
                this.colorOriginal = null;

                this.luzInterior = null; // ← luz que se creará dentro del edificio

                this.el.addEventListener('click', () => {
                    this.toggleLuces();
                });
            },

            setLuces: function (estado) {
                if (estado === this.encendidas) return;
                this.toggleLuces();
            },

            toggleLuces: function () {
                const mesh = this.el.getObject3D('mesh');
                if (!mesh) return;

                mesh.traverse((node) => {
                    if (node.isMesh && node.name === 'Ventanas') {

                        if (!this.colorOriginal) {
                            this.colorOriginal = node.material.color.clone();
                        }

                        if (this.encendidas) {
                            // APAGAR
                            node.material.color.copy(this.colorOriginal);
                            node.material.emissive.set('#000000');
                            node.material.emissiveIntensity = 0;
                        } else {
                            // ENCENDER
                            node.material.color.set('#FFD700');
                            node.material.emissive.set('#FFD700');
                            node.material.emissiveIntensity = 1.5;
                        }

                        node.material.needsUpdate = true;
                    }
                });

                // ==========================
                //   ENCENDER / APAGAR LUZ INTERIOR
                // ==========================
                if (!this.encendidas) {
                    // Crear luz si no existe
                    this.luzInterior = document.createElement('a-entity');
                    this.luzInterior.setAttribute('light', {
                        type: 'point',
                        color: '#FFD700',
                        intensity: 10,
                        distance: 20
                    });

                    // Posición aproximada dentro del edificio
                    this.luzInterior.setAttribute('position', '4 5 0');

                    this.el.appendChild(this.luzInterior);
                } else {
                    // Eliminar luz al apagar
                    if (this.luzInterior) {
                        this.el.removeChild(this.luzInterior);
                        this.luzInterior = null;
                    }
                }

                this.encendidas = !this.encendidas;
            }
        });

        // ==========================
        //   COMPONENTE: Botón general luces
        // ==========================
        AFRAME.registerComponent('boton-luces', {
            init: function () {
                this.lucesEncendidas = false;

                this.entorno = document.querySelector('#entorno');

                this.el.addEventListener('click', () => {
                    this.lucesEncendidas = !this.lucesEncendidas;

                    // Encender/apagar edificios
                    const casas = document.querySelectorAll('[encender-ventanas]');
                    casas.forEach(casa => {
                        casa.components['encender-ventanas'].setLuces(this.lucesEncendidas);
                    });

                    // Cambiar color del botón
                    this.el.setAttribute('material', 'color',
                        this.lucesEncendidas ? '#FFD700' : '#333');

                    // ==========================
                    //   CAMBIO DE CIELO (DÍA ↔ NOCHE)
                    // ==========================
                    if (this.lucesEncendidas) {
                        // NOCHE
                        this.entorno.setAttribute('environment', {
                            preset: 'starry',        // mantiene tu entorno
                            skyType: 'atmosphere',   // necesario para estrellas
                            lighting: 'dusk',
                            stars: 5000,             // cantidad de estrellas (default del preset)
                            starColor: '#ffffff',
                            horizonColor: '#0a0a0a',
                            skyColor: '#000010',
                            fog: 0.6
                        });
                    } else {
                        // DÍA
                        this.entorno.setAttribute('environment', {
                            preset: 'starry',
                            lighting: 'sunset',
                            skyType: 'color',
                            skyColor: '#88ccee',
                            horizonColor: '#ffffff',
                            stars: 0,        // desactivar estrellas
                            fog: 0.2
                        });
                    }
                });
            }
        });

        // ==========================
        //   COMPONENTE: Rotar cartel
        // ==========================
        AFRAME.registerComponent('rotar-cartel', {
            schema: {
                speed: { type: 'number', default: 30 } // grados por segundo
            },

            init: function () {
                this.cartelNode = null;

                this.el.addEventListener('model-loaded', () => {
                    const mesh = this.el.getObject3D('mesh');
                    if (!mesh) return;

                    // Buscar el nodo Cartel sin filtrar por tipo
                    mesh.traverse((node) => {
                        if (node.name === 'Cartel') {
                            this.cartelNode = node;
                        }
                    });

                    if (!this.cartelNode) {
                        console.warn("No se encontró un nodo llamado 'Cartel' en este modelo.");
                    }
                });
            },

            tick: function (time, timeDelta) {
                if (!this.cartelNode) return;

                // Velocidad en radianes por milisegundo
                const rad = THREE.MathUtils.degToRad(this.data.speed) * (timeDelta / 1000);

                // Girar sobre su propio eje Y
                this.cartelNode.rotation.y += rad;
            }
        });

        AFRAME.registerComponent('debug-nodos', {
            init: function () {
                this.el.addEventListener('model-loaded', () => {
                    const mesh = this.el.getObject3D('mesh');

                    console.log("Nodos del modelo:");
                    mesh.traverse((node) => {
                        if (node.isMesh || node.isObject3D) {
                            console.log(node.name);
                        }
                    });
                });
            }
        });

        AFRAME.registerComponent('generar-linea-arboles', {
            schema: {
                cantidad: { type: 'number', default: 10 },
                distancia: { type: 'number', default: 5 },
                direccion: { type: 'vec3', default: { x: 0, y: 0, z: 1 } },
            },

            init: function () {
                const sceneEl = this.el.sceneEl;
                const inicio = this.el.getAttribute('position');

                for (let i = 1; i <= this.data.cantidad; i++) {
                    const arbol = document.createElement('a-entity');

                    // Copiar el modelo del árbol original
                    const modelo = this.el.getAttribute('gltf-model');
                    arbol.setAttribute('gltf-model', modelo);

                    // Posición del árbol
                    const posX = inicio.x + this.data.direccion.x * this.data.distancia * i;
                    const posY = inicio.y + this.data.direccion.y * this.data.distancia * i;
                    const posZ = inicio.z + this.data.direccion.z * this.data.distancia * i;
                    arbol.setAttribute('position', `${posX} ${posY} ${posZ}`);

                    // Rotación aleatoria opcional
                    //arbol.setAttribute('rotation', `0 ${Math.random() * 360} 0`);

                    // Escala
                    const escala = this.el.getAttribute('scale');
                    arbol.setAttribute('scale', `${escala.x} ${escala.y} ${escala.z}`);
                    arbol.setAttribute('static-body', 'shape:box');

                    sceneEl.appendChild(arbol);
                }
            }
        });

        AFRAME.registerComponent('generar-linea-lamparas', {
            schema: {
                cantidad: { type: 'number', default: 10 },
                distancia: { type: 'number', default: 5 },
                direccion: { type: 'vec3', default: { x: 0, y: 0, z: 1 } },
            },

            init: function () {
                const sceneEl = this.el.sceneEl;
                const inicio = this.el.getAttribute('position');

                for (let i = 1; i <= this.data.cantidad; i++) {
                    const lampara = document.createElement('a-entity');

                    // Copiar el modelo del árbol original
                    const modelo = this.el.getAttribute('gltf-model');
                    lampara.setAttribute('gltf-model', modelo);

                    // Posición del árbol
                    const posX = inicio.x + this.data.direccion.x * this.data.distancia * i;
                    const posY = inicio.y + this.data.direccion.y * this.data.distancia * i;
                    const posZ = inicio.z + this.data.direccion.z * this.data.distancia * i;
                    lampara.setAttribute('position', `${posX} ${posY} ${posZ}`);

                    // Rotación aleatoria opcional
                    //arbol.setAttribute('rotation', `0 ${Math.random() * 360} 0`);

                    // Escala
                    const escala = this.el.getAttribute('scale');
                    lampara.setAttribute('scale', `${escala.x} ${escala.y} ${escala.z}`);
                    lampara.setAttribute('static-body', 'shape:box');
                    lampara.setAttribute('encender-ventanas', '');


                    sceneEl.appendChild(lampara);
                }
            }
        });

    </script>
</head>

<body>
    <a-scene physics="gravity: -9.8; debug: true; restitution: 0.3">
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="Edificio1"
                src="https://carloslajarasanchez.github.io/Models/Edificio1.glb"></a-asset-item>
            <a-asset-item id="Edificio2"
                src="https://carloslajarasanchez.github.io/Models/Edificio2.glb"></a-asset-item>
            <a-asset-item id="CentroPokemon"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/CentroPokemon.glb"></a-asset-item>
            <a-asset-item id="TiendaPokemon"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/TiendaPokemon.glb"></a-asset-item>
            <a-asset-item id="Casa"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Casa1.glb"></a-asset-item>
            <a-asset-item id="Arbol"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Arbol.glb"></a-asset-item>
            <a-asset-item id="Pokeball"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Pokeball.glb"></a-asset-item>
            <a-asset-item id="Teatro"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Teatro.glb"></a-asset-item>
            <a-asset-item id="Gym" src="https://carloslajarasanchez.github.io/Models/PokemonGLT/GYM.glb"></a-asset-item>
            <a-asset-item id="Lago"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Lago.glb"></a-asset-item>
            <a-asset-item id="Mountain"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Mountain.glb"></a-asset-item>
            <a-asset-item id="TorreQuemada"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/TorreQuemada.glb"></a-asset-item>
            <a-asset-item id="CasaNorte"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/CasaNorte.glb"></a-asset-item>
            <a-asset-item id="Lampara"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Lampara.glb"></a-asset-item>
            <a-asset-item id="Torre"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Torre.glb"></a-asset-item>
        </a-assets>

        <!-- Player -->
        <!--<a-entity id="jugador"
                  position="0 0.8 0"
                  geometry="primitive: cylinder; radius: 0.3; height: 1.6"
                  dynamic-body="shape: cylinder; mass: 1"
                  movement-controls="fly: false">
            <a-camera position="0 0.8 0" look-controls>
                <a-cursor raycaster="objects: .clickable"></a-cursor>
            </a-camera>
        </a-entity>-->

        <a-entity id="player" position="0 1.6 0" camera look-controls wasd-controls="acceleration: 40"
            kinematic-body="shape: cylinder; radius: 0.35; height: 1.6">
            <a-cursor raycaster="objects: .clickable"></a-cursor>
        </a-entity>

        <a-box position="0 2 -5" width="1" height="1" depth="1" color="#4CC3D9" dynamic-body></a-box>
        <a-box id="suelo" position="0 -0.5 0" width="100" height="1" depth="100" color="#7BC8A4" visible="false"
            static-body></a-box>



        <!-- Cámara -->
        <!--<a-camera position="0 1.6 10">
        <a-cursor raycaster="objects: .clickable"></a-cursor>
        </a-camera>-->
        <!-- Entorno con ID -->
        <a-entity id="entorno" environment="
                  preset: starry;
                  lighting: sunset;
                  lightPosition: 0 0 1;
                  shadow: true;
                  skyType: color;
                  skyColor: #88ccee;
                  horizonColor: #ffffff;
                  ground: hills;
                  groundTexture: walkernoise;
                  groundColor: #666666;
                  groundColor2: #515151;
                  stageSize: 500;
                  playArea: 200;
                  grid: none;
                  ">
        </a-entity>

        <audio id="testAudio" src="Music/Ciudad-Iris.mp3" loop></audio>

        <!--      dressing: trees;
                  dressingScale: 100;
                  dressingAmount: 2;
                  dressingColor: #3c3c3c;
        -->

        <!-- Edificios -->
        <a-entity gltf-model="#CentroPokemon" position="0 0 -15" rotation="0 -90 0" scale="2 2 2"
            static-body="shape: box" class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#Casa" position="30 0 -15" rotation="0 0 0" scale="2 2 2" static-body="shape: box"
            class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#Casa" position="-30 0 -16" rotation="0 0 0" scale="2 2 2" static-body="shape: box"
            class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#Casa" position="-70 0 -45" rotation="0 0 0" scale="2 2 2" static-body="shape: box"
            class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#Casa" position="-70 0 -75" rotation="0 -90 0" scale="2 2 2" static-body="shape: box"
            class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#Casa" position="-30 0 -75" rotation="0 -90 0" scale="2 2 2" static-body="shape: box"
            class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#TorreQuemada" position="-70 0 -125" rotation="0 -90 0" scale="2 2 2"
            static-body="shape: box" class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#CasaNorte" position="-11 0 -115" rotation="0 0 0" scale="2 2 2" static-body="shape: box"
            class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#Gym" position="-70 0 -20" rotation="0 -90 0" scale="1.7 2 2" static-body="shape: box"
            class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#Teatro" position="0 0 -43" rotation="0 -90 0" scale="2 2 2" static-body="shape: box"
            class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#TiendaPokemon" position="30 0 -41" rotation="0 -90 0" scale="2 2 2"
            rotar-cartel="speed: 45" class="clickable" encender-ventanas>
        </a-entity>

        <a-entity gltf-model="#Lago" position="13 .25 -100" rotation="0 -90 0" scale="2 2 2">
        </a-entity>

        <a-entity gltf-model="#Mountain" position="15 .25 -200" rotation="0 -90 0" scale="10 10 10">
        </a-entity>

        <!-- Limite atras arboles -->
        <a-entity gltf-model="#Arbol" position="-5 0 15" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 20; distancia: 5; direccion: -1 0 0">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="0 0 15" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 11; distancia: 5; direccion: 1 0 0">
        </a-entity>

        <a-entity gltf-model="#Arbol" position="-2.5 0 20" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 20; distancia: 5; direccion: -1 0 0">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="2.5 0 20" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 11; distancia: 5; direccion: 1 0 0">
        </a-entity>

        <a-entity gltf-model="#Arbol" position="-5 0 25" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 20; distancia: 5; direccion: -1 0 0">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="0 0 25" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 11; distancia: 5; direccion: 1 0 0">
        </a-entity>

        <!-- Limite izquiedo arboles -->
        <a-entity gltf-model="#Arbol" position="-105 0 15" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 20; distancia: 5; direccion: 0 0 -1">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="-110 0 17.5" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 20; distancia: 5; direccion: 0 0 -1">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="-115 0 15" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 20; distancia: 5; direccion: 0 0 -1">
        </a-entity>
        <!-- Limite derecho arboles -->
        <a-entity gltf-model="#Arbol" position="60 0 15" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 21; distancia: 5; direccion: 0 0 -1">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="65 0 17.5" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 21; distancia: 5; direccion: 0 0 -1">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="70 0 15" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 21; distancia: 5; direccion: 0 0 -1">
        </a-entity>

        <!-- Limite delante derecha arboles -->
        <a-entity gltf-model="#Arbol" position="55 0 -90" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 5; distancia: 5; direccion: -1 0 0">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="55 0 -85" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 4; distancia: 5; direccion: -1 0 0">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="55 0 -100" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 5; distancia: 5; direccion: -1 0 0">
        </a-entity>
        <a-entity gltf-model="#Arbol" position="57.5 0 -95" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 5; distancia: 5; direccion: -1 0 0">
        </a-entity>

        <!-- Arboles casas-->
        <a-entity gltf-model="#Arbol" position="22 0 -17.5" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 1; distancia: 5; direccion: 0 0 1">
        </a-entity>

        <a-entity gltf-model="#Arbol" position="-38 0 -18.5" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 1; distancia: 5; direccion: 0 0 1">
        </a-entity>

        <a-entity gltf-model="#Arbol" position="-78 0 -47.5" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 1; distancia: 5; direccion: 0 0 1">
        </a-entity>

        <a-entity gltf-model="#Arbol" position="-61 0 -77.5" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 1; distancia: 5; direccion: 0 0 1">
        </a-entity>

        <a-entity gltf-model="#Arbol" position="-21 0 -77.5" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            generar-linea-arboles="cantidad: 1; distancia: 5; direccion: 0 0 1">
        </a-entity>

        <!-- Botón -->
        <a-box position="0 1 -2" depth="0.2" height="0.2" width="0.2" color="#333" class="clickable" boton-luces>
        </a-box>

        <a-entity id="pokeball" gltf-model="#Pokeball" dynamic-body="mass: 1; shape: sphere" grabbable class="clickable"
            position="0 1 -2" rotation="0 90 0" pokeball-logic>
        </a-entity>

        <!-- Lamparas -->
        <a-entity gltf-model="#Lampara" position="50 0 -80.5" rotation="0 90 0" scale="2 2 2" static-body="shape: box"
            class="clickable" generar-linea-lamparas="cantidad: 3; distancia: 3; direccion: -1 0 0" encender-ventanas
            debug-nodos>
        </a-entity>
    </a-scene>

    <!-- Reproducir musica -->
    <script>
        document.addEventListener('click', () => {
            document.getElementById('testAudio').play();
        });
    </script>
</body>

</html>