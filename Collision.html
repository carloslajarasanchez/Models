<html>

<head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script
        src="https://unpkg.com/aframe-environment-component@1.5.x/dist/aframe-environment-component.min.js"></script>
    <script src="aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

    <!--<script src="https://unpkg.com/super-hands@3.0.3/dist/super-hands.min.js"></script>-->


    <script>
        AFRAME.registerComponent('pokeball-logic', {
            schema: {
                stopDelay: { type: 'number', default: 1500 },
                pokemonDisappearDelay: { type: 'number', default: 1000 },
                shrinkDuration: { type: 'number', default: 700 } // duración de reducción
            },

            init: function () {
                this.el.addEventListener('collide', (e) => {
                    const target = e.detail.body.el;

                    if (target && target.classList.contains('pokemon')) {

                        // EVITAR MULTIPLES CAPTURAS
                        if (target.isCaptured) return;
                        target.isCaptured = true;

                        //─── REPRODUCIR SONIDO DEL POKÉMON ───
                        const soundURL = target.getAttribute('capture-sound');
                        if (soundURL) {
                            const audio = document.createElement('audio');
                            audio.src = soundURL;
                            audio.volume = 1.0;
                            audio.play();
                            audio.addEventListener('ended', () => audio.remove());
                        }

                        // ─── 1. Animación en la pokeball ───
                        this.el.setAttribute('animation-mixer', {
                            clip: 'ArribaAction',
                            loop: 'once',
                            crossFadeDuration: 0,
                            clampWhenFinished: true
                        });

                        // ─── 2. Crear luz temporal en el Pokémon ───
                        const light = document.createElement('a-entity');
                        light.setAttribute('light', {
                            type: 'point',
                            intensity: 10,
                            distance: 5,
                            color: '#f80000'
                        });
                        light.setAttribute('position', '0 2 0');
                        target.appendChild(light);

                        // ─── 3. Cambiar material del Pokémon → emisivo + transparente ───
                        target.object3D.traverse((node) => {
                            if (node.isMesh) {
                                node.originalMaterial = node.material;
                                node.material = new THREE.MeshStandardMaterial({
                                    color: '#f80000',
                                    emissive: new THREE.Color('red'),
                                    emissiveIntensity: 10,
                                    transparent: true,
                                    opacity: 0.5,
                                    roughness: node.originalMaterial.roughness ?? 0.8,
                                    metalness: node.originalMaterial.metalness ?? 0
                                });
                            }
                        });

                        // parar su movimiento ping-pong
                        target.removeAttribute('pingpong-move-smooth');

                        // ─── 4. Tras el tiempo, reducir poco a poco su escala ───
                        setTimeout(() => {

                            const startScale = target.object3D.scale.clone();
                            const duration = this.data.shrinkDuration;
                            const startTime = performance.now();

                            const shrinkTick = (now) => {
                                const elapsed = now - startTime;
                                let t = elapsed / duration;
                                if (t > 1) t = 1;

                                const newScale = 1 - t;
                                target.object3D.scale.set(
                                    startScale.x * newScale,
                                    startScale.y * newScale,
                                    startScale.z * newScale
                                );

                                if (t < 1) {
                                    requestAnimationFrame(shrinkTick);
                                } else {
                                    // ─── 5. Quitar luz y "desactivar" Pokémon ───
                                    if (light.parentElement) light.parentElement.removeChild(light);

                                    target.setAttribute('visible', 'false');
                                    target.setAttribute('position', '0 -5 0');

                                    // ─── 6. Incrementar contador global ───
                                    const counterSystem = this.el.sceneEl.systems['pokemon-counter'];
                                    counterSystem.addCapture();

                                    // ─── 7. Volver animación Idle en la pokeball ───
                                    this.el.setAttribute('animation-mixer', {
                                        clip: 'Idle',
                                        loop: 'repeat'
                                    });
                                }
                            };

                            requestAnimationFrame(shrinkTick);

                        }, this.data.pokemonDisappearDelay);

                        // ─── 8. Detener la pokeball automáticamente ───
                        setTimeout(() => {
                            if (this.el.body) {
                                this.el.body.velocity.set(0, 0, 0);
                                this.el.body.angularVelocity.set(0, 0, 0);
                                this.el.body.sleep();
                            }
                        }, this.data.stopDelay);
                    }
                });
            }
        });

        AFRAME.registerComponent('cursor-grab', {
            init: function () {
                const cameraEl = document.querySelector('#camera');
                this.grabbedBall = null;

                // ────── CLICK PARA COGER ──────
                this.el.addEventListener('click', (e) => {
                    const intersected = e.detail.intersectedEl;
                    if (!intersected || !intersected.classList.contains('clickable')) return;

                    if (!intersected.isGrabbed) {
                        intersected.isGrabbed = true;
                        this.grabbedBall = intersected;

                        // Quitar físicas
                        intersected.removeAttribute('dynamic-body');

                        // Añadir a la cámara para que siga
                        cameraEl.object3D.add(intersected.object3D);
                        intersected.object3D.position.set(0, 0.1, -1);
                        intersected.object3D.rotation.set(0, 1.55, 0);
                    }
                });

                // ────── ESPACIO PARA SOLTAR ──────
                window.addEventListener('keydown', (evt) => {
                    if (evt.code === 'Space' && this.grabbedBall) {
                        const ball = this.grabbedBall;
                        ball.isGrabbed = false;

                        // Guardamos la posición actual de la bola (donde está delante de la cámara)
                        const currentPos = new THREE.Vector3();
                        ball.object3D.getWorldPosition(currentPos);

                        // Quitar de la cámara y añadir al root
                        const sceneObj = document.querySelector('a-scene').object3D;
                        sceneObj.add(ball.object3D);
                        ball.object3D.position.copy(currentPos);

                        // Activar física
                        ball.setAttribute('dynamic-body', 'mass: 1; shape: sphere');

                        // Lanzar hacia adelante + un poco hacia arriba según cámara
                        const cameraObj = cameraEl.object3D;
                        const forward = new THREE.Vector3(0, 0, -1);
                        forward.applyQuaternion(cameraObj.quaternion);
                        forward.normalize().multiplyScalar(5); // fuerza
                        forward.y += 2; // un poco de elevación
                        ball.body.velocity.set(forward.x, forward.y, forward.z);

                        this.grabbedBall = null;
                    }
                });
            }

        });

        // ────── ESPACIO PARA SOLTAR ──────
        window.addEventListener('keydown', (evt) => {
            if (evt.code === 'Space' && this.grabbedBall) {
                const ball = this.grabbedBall;
                ball.isGrabbed = false;

                // Quitar de la cámara y añadir al root
                const sceneObj = document.querySelector('a-scene').object3D;
                sceneObj.add(ball.object3D);

                // Activar física
                ball.setAttribute('dynamic-body', 'mass: 1; shape: sphere');

                // Lanzar hacia adelante según cámara
                const cameraObj = cameraEl.object3D;
                const forward = new THREE.Vector3(0, .5, -1);
                forward.applyQuaternion(cameraObj.quaternion);
                forward.multiplyScalar(5); // fuerza de lanzamiento
                ball.body.velocity.set(forward.x, forward.y + 2, forward.z);

                this.grabbedBall = null;
            }
        });


        AFRAME.registerComponent("damping", {
            schema: {
                linear: { type: "number", default: 0.1 },
                angular: { type: "number", default: 0.1 }
            },

            init: function () {
                const body = this.el.body;
                if (!body) {
                    this.el.addEventListener("body-loaded", () => {
                        this.el.body.linearDamping = this.data.linear;
                        this.el.body.angularDamping = this.data.angular;
                    });
                    return;
                }

                body.linearDamping = this.data.linear;
                body.angularDamping = this.data.angular;
            }
        });

        //------ Suma de pokemon capturados ------
        AFRAME.registerSystem('pokemon-counter', {
            schema: { count: { type: 'int', default: 0 } },

            addCapture: function () {
                this.data.count += 1;
                console.log('Contador: ', this.data.count);
                // Emitimos un evento global con la cantidad
                this.el.sceneEl.emit('pokemonCaptured', { count: this.data.count });
            }
        });

        //-------- Boton subir torre ---------------
        AFRAME.registerComponent('unlock-button', {
            init: function () {
                this.el.setAttribute('material', 'color', 'gray'); // inicialmente bloqueado
                this.el.setAttribute('clickable', ''); // para poder interactuar después

                // Escuchar el evento global
                this.el.sceneEl.addEventListener('pokemonCaptured', (e) => {
                    if (e.detail.count >= 6) {
                        this.el.setAttribute('material', 'color', 'green'); // desbloqueado visualmente
                        this.el.addEventListener('click', this.onClick); // activar interacción
                    }
                });
            },

            onClick: function () {
                console.log('Botón físico pulsado!');
                // Aquí puedes llamar a la función que quieras
            }
        });

        AFRAME.registerComponent('pingpong-move-smooth', {
            schema: {
                start: { type: 'vec3', default: { x: 0, y: 0, z: -5 } },
                end: { type: 'vec3', default: { x: 1, y: 0, z: -10 } },
                speed: { type: 'number', default: 0.05 },      // velocidad de movimiento
                rotSpeed: { type: 'number', default: 0.05 }    // velocidad de rotación
            },
            init: function () {
                this.forward = true; // dirección
                this.state = 'moving'; // 'moving' o 'turning'
                this.target = new THREE.Vector3();
                this.el.object3D.position.copy(this.data.start);
                this.setTarget();
            },
            setTarget: function () {
                const start = new THREE.Vector3(this.data.start.x, this.data.start.y, this.data.start.z);
                const end = new THREE.Vector3(this.data.end.x, this.data.end.y, this.data.end.z);
                this.target.copy(this.forward ? end : start);

                // Calculamos la rotación deseada en Y hacia el objetivo
                const direction = new THREE.Vector3().subVectors(this.target, this.el.object3D.position);
                const yRotation = Math.atan2(direction.x, direction.z);
                this.targetQuat = new THREE.Quaternion().setFromEuler(new THREE.Euler(0, yRotation, 0));
                this.state = 'turning';
            },
            tick: function (time, delta) {
                const obj = this.el.object3D;

                if (this.state === 'turning') {
                    // Girar poco a poco
                    obj.quaternion.slerp(this.targetQuat, this.data.rotSpeed);
                    // Si está casi llegando a la rotación deseada, pasar a mover
                    if (obj.quaternion.angleTo(this.targetQuat) < 0.01) {
                        obj.quaternion.copy(this.targetQuat);
                        this.state = 'moving';
                    }
                } else if (this.state === 'moving') {
                    // Avanzar hacia el objetivo
                    obj.position.lerp(this.target, this.data.speed);
                    // Si llega cerca del objetivo, cambiar de dirección y girar
                    if (obj.position.distanceTo(this.target) < 0.05) {
                        this.forward = !this.forward;
                        this.setTarget();
                    }
                }
            }
        });
    </script>
</head>

<body>
    <a-scene physics="gravity: -9.8; debug: true">
        <a-assets>
            <a-asset-item id="pokeball"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Pokeball.glb"></a-asset-item>
            <a-asset-item id="totodile"
                src="https://carloslajarasanchez.github.io/Models/PokemonGLT/Totodile.glb"></a-asset-item>
        </a-assets>
        <a-camera id="camera" position="0 1.6 0" look-controls>
            <a-entity id="hand-slot" position="0 -0.2 -1"></a-entity>
            <a-cursor fuse="false" raycaster="objects: .clickable" cursor-grab></a-cursor>
        </a-camera>




        <!-- Entorno con ID -->
        <a-entity id="entorno" environment="
                  preset: starry;
                  lighting: sunset;
                  lightPosition: 0 0 1;
                  shadow: true;
                  skyType: color;
                  skyColor: #88ccee;
                  horizonColor: #ffffff;
                  groundTexture: walkernoise;
                  groundColor: #666666;
                  groundColor2: #515151;
                  dressing: towers;
                  dressingScale: 100;
                  dressingAmount: 2;
                  dressingColor: #3c3c3c;
                  playArea: 100;
                  grid: none;
                  ">
        </a-entity>

        <a-box id="suelo" position="0 -0.5S 0" rotation="0 90 0" width="100" height="1" depth="100" color="#7BC8A4"
            visible="false" static-body></a-box>

        <a-entity id="pokeball" gltf-model="#pokeball" dynamic-body="mass: 1; shape: sphere" grabbable class="clickable"
            position="0 1 -2" rotation="0 90 0" pokeball-logic="stopDelay:3000; pokemonDisappearDelay:1500"
            damping="linear: .2; angular: 1">
        </a-entity>

        <!-- Pokémon -->
        <a-entity id="totodile" gltf-model="#totodile" static-body scale=".1 .1 .1s" class="pokemon" position="0 0 -5"
            pingpong-move-smooth="start: 0 0 -5; end: 0 0 -10; speed: 0.02; rotSpeed: 0.02"
            capture-sound="Music/Cries-Totodile.mp3">
        </a-entity>

        <a-entity id="testButton" geometry="primitive: box; width: 0.5; height: 0.2; depth: 0.1" position="0 1 5"
            unlock-button></a-entity>

    </a-scene>

</body>

</html>